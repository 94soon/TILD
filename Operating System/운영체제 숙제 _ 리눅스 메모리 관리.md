# 리눅스 메모리 관리 

### 메모리 관리 소개 
* top와 같은 일반적인 리눅스 시스템을 메모리 할당을 살펴보면 여유메모리가 얼마 남지 않았다는 것을 살펴볼 수 있다. 
* 이러한 이유는 디스크 캐시를 통해 메모리에 할당하기 때문이다. 
* 캐시 메모이는 실행중이거나 새로 시작될 프로그램이 메모리를 필요로 하면 빠르게 대체되어야 하기 때문에 OS는 항상 여유있는 만큼 확보하게 된다. 
	* 리눅스가 디스크 캐시용으로 메모리를 많이 사용되는 이유는 캐시가 사용되지 않으면 메모리 공간이 낭비가 되기 때문이다. 캐시를 유지하는 것은 어떤 프로그램이 같은 데이터를 다시 필요로 하고 있다는 것으로, 캐시에서 정보를 읽어드리는 것은 하드디스크에서 읽어들이는 것에 비해 약 1000배 이상의 속도가 차이가 난다. 
* 다만 정보의 손실은 발생하지 않는다. 


* 또한 예를 들어 512MB 메모리가 장착된 시스템이 있다고 가정할때 가용메모리가 503MB만 사용가능하다고 뜨는 경우 커널이 스왑할 수 없어서 즉, 커널이 차지하고 있는 메모리 공간은 절대로 사용될 수 없기 때문이다. 

### 이해할 수 없는 x86의 880MB 제한 
* 기본적으로 리눅스 커널은 적은 메모리만으로도 실행할 수 있고 관리가 가능하다. 
* 페이지 테이블 관리가 조금은 용이하게 되고, 순서대로 메모리 접근이 조금 더 빨라지게 된다. 
* 하지만 RAM의 총 용량이 880MB에 근접하게 되면 커널은 모든 메모리를 사용할 수 없는 상황이 발생하게 된다. 
* 이러한 문제는 리눅스 커널 2.4, 2.6에 해당되는 상황이며 현재는 이런문제가 발생하지 않는다.    


### 버퍼와 캐시의 차이 
* 버퍼 
	* 특정 블록 장치와 관련이 있으며 파일시스템의 메타데이터를 캐시에 저장하는 것 뿐만 아니라 in-flight 페이지를 추적하는 것 또한 할 수 있다. 
* 캐시 
	* 캐시에 저장된 파일 데이터만 관리한다. 

* 즉, 버퍼는 디렉토리에 무엇이 있는지, 파일들의 권한들은 어떠한가를 저장하며, 어떤 메모리가 특정 블록 장치를 위해 기록이 되거나 혹은 읽어ㄷ 들여지는 것을 추적한다. 하지만 캐시는 파일들의 내용 그 자체만을 유지한다는 것이 차이점이라 할 수 있다. 

### Swappiness 

* 리눅스 커널 2.6 이후로, 메모리가 꽉 차게 될 때, 리눅스는 캐시의 크기를 축소하는 것이 아니라, 얼마의 메모리를 디스크로 스왑해야 하는지를 조율하기 위한 방법이 있었다.
* 어떤 하나의 응용 프로그램이 메모리를 필요로 하나 모든 RAM이 사용되고 있을 때, 커널은 일부 메모리 공간을 확보 할 수 있는 두가지 방법을 가지고 있다. 
	*  커널은 가장 오래된 데이터를 삭제함으로써 RAM에 있는 디스크 캐시를 줄인다.
	*  상대적으로 덜 사용되는 부분을 디스크의 스왑 파티션 밖으로 스왑한다. 
* 하지만 커널 2.6이전 버전에는 사용자가 그러한 계산에 영향을 끼칠 수 있는 수단이 없었기 때문에 커널이 잘못된 선택을 하여 성능이 저하되는 상황이 발생 
* Swappiness는 응용프로그램을 스왑하고 캐시를 비워두는 것 사이에 균형의 변화를 주기 위해서 0 ~ 100까지 중 하나의 값을 선택한다. 
* 100을 선택하면 커널은 사용하고 있지 않은 페이지를 찾아내어 모두 스왑해 버린다. 
* 다른 경우에는 스왑이 응용프로그램이 메모리를 얼마나 점유하고 있는지 그리고 얼마나 적은 캐시가 사용하지 않는 것들을 찾아내고 빼내는가에 따라 스왑이 발생할 수 있고 그렇지 않을 수도 있다. 
* 기본적으로 Swappiness의 값은 60이다. 