# MPLS & SD-WAN

![](https://www.optcore.net/wp-content/uploads/2017/11/SD-WAN-vs-MPLS-how-to-choose_600.jpg)

* 급격하게 발전하는 인프라 환경에서 네트워크를 구축함에 있어서 SD-WAN과 MPLS 사이에서 기술, 성능과 공급업체 등의 여러 장단점에 사이에서 무엇을 선택해야 할지 고민이 될 것입니다. 
*  오늘 MPLS와 SD-WAN은 어떤 특징을 가지고 있으며, 어디에 사용하는 것이 더 적합한지에 대한 내용으로 정리합니다. 



### MPLS (Multi-Protocol Label Switching)

![](https://cdn-images-1.medium.com/max/1600/1*Bkjy8wZGi8chyvqleZiGwg.png)

* MPLS는 Multi-Protocol Label Switching의 약자로 기존의 네트워크의 문제 해결을 위해서 등장하게 되었습니다. 

  * 기존 네트워크 환경에서 라우터는 네트워크 계층(L3)의 헤더만 보고 각 패킷의 포워딩 정책을 실행합니다
  * 각 패킷이 라우터에 도착할 때마다 라우터는 패킷을 보낼 다음 지점을 계산해야 하며, 이러한 작업을 위해 라우팅 테이블을 확인하여 수행합니다. 
  * 이러한 문제점 때문에 VoIP, 영상과 같은 민감하고 빠른 처리가 필요한 환경에서는 처리속도가 떨어진다는 된다는 단점을 가지고 있습니다. 

* MPLS 기술은 기존의 라우팅 방식을 기반으로 ATM의 고속 멀티 서비스 교환 기능을 결합하여 IP 패킷을 전달하는 방식으로 대규모의 망에서 고속의 데이터 전송과 QoS 등의 기능을 제공을 목적으로 제시하게 되었습니다. 

* MPLS은 미리 결정된 고효율 경로를 설정하는 방법으로 성능문제를 해결하는데, 패킷이 처음 네트워크로 진입할 때 특정 FEC(Forwarding Equivalence Class)에 할당되며, 이는 패킷에 짧은 비트 시퀀스(레이블)로 표시됩니다. 

  ![](https://slideplayer.com/slide/7350283/24/images/39/Traffic+Aggregates%3A+Forwarding+Equivalence+Classes.jpg)

  ![](https://i.stack.imgur.com/qkxp8.png)

* 각 라우터는 특정 FEC 유형의 패킷을 어떻게 처리해야 할지 나타내는 테이블이 있기 때문에 패킷이 네트워크에 진입하면 라우터는 헤더 분석을 할 필요가 없습니다. 

* 따라서, MPLS에서는 짧고 고정된 길이의 레이블을 기반으로 패킷을 전송하는 레이블 교환(Lable Switching) 방식을 이용하고, 목적지까지 패킷을 전송하는데 있어서 단 한 번만 수행됩니다. 이를 통해 고속의 L2계층의 데이터 전송과 경우에 따라서는 Traffic Engineering이나 VPN(Virtual Private Network)과 같은 기능을 제공합니다. 

#### IP Routing의 문제점 

* **IP Header Processing **

  * 라우터에서 패킷을 다음 hop으로 전송하기 위해서는 TTL, Checksum, Routing Table Lookup 등의 처리가 필요 합니다.

* **Longest Prefix Mathing **

  ![](https://cdncontribute.geeksforgeeks.org/wp-content/uploads/Computer-Networks-Longest-Prefix-Matching-in-Routers.png)

  * 패킷이 라우터로 들어오면 라우터는 패킷을 확인하여 다음 hop으로 전송해야 합니다. 
  * 그림에서 192.24.0.0/18 네트워크는 192.24.12.0 ~ 192.24.15.255 까지의 주소 범위를 가지고 있고 패킷은 D로 전송됩니다.
  * 하지만 문제는 192.168.24.12.0/22 네트워크 영역은 B의 영역으로 전달되어야 하는데 위의 네트워크 영역과 겹치는 문제가 발생합니다. 이를 위해서 라우터는 Longest Prefix Mathing 기법을 사용하여 CIDR로 나누어진 네트워크 패킷이 들어왔을 때 Routing Table에서 가장 긴 subnet mask에 match 되는 네트워크 경로로 선택되어 집니다. 
    * 따라서 192.24.12.0 ~ 192.24.15.255 IP는 B홉으로 전달됩니다. 
  * 이러한 과정은 등록된 Routing Table에 따라서 Routing Table Lookup이 지연될 수 있다는 한계가 있습니다. 

* **Hot-by-Hot Forwarding**

  * 패킷이 목적지까지 전달되기 까지 각 라우터에서 각각 위와 같은 Longest Prefix Mathing 방식을 사용하기 때문에 고속 데이터 전송에 부적합 합니다. 

* **Best Effort Service**

  * 현제 인터넷 망은 단말끼리 연결되어 있는 형태이며, 단말측에서 지능적인 역할을 담당하고 있습니다. 따라서 망측에서 IP 계층이 전송을 위해서 최대한의 노력을 하지만 확실한 전송 보장은 하지 않기 때문에 전송 지연이나 패킷 손실에 대해서 보장 처리를 수행하기 어렵다는 단점이 있습니다. 

#### MPLS 동작과정 

* MPLS의 강점은 특정 기반 기술에 얽메이지 않는다는 점입니다. MPLS는 ATM과 프레임 릴레이 시대에 간소화와 성능개선을 위한 오버레이 기법으로 설계되었습니다.(MP, 즉 "멀티 프로토콜"에 해당)

  ![](https://t1.daumcdn.net/cfile/tistory/19254C4F4DAA4BA82A)



* 각 데이터에 Lable을 추가하여 L2 기반에서 스위칭을 하게 함으로서 고속의 데이터 처리를 진행할 수 있도록 합니다. 

  ![](https://t1.daumcdn.net/cfile/tistory/1140BD4F4D9FF3651F)

  ![](https://5.imimg.com/data5/DD/DD/GLADMIN-/mpls-aggregation-switch-500x500.jpg)

1. MPLS 도메인 내에서 각 노드들은 OSPF((Open Shortest Path First)나 BGP(Border Gateway
   Protocol)을 사용하여 LER(Labe Edge Router)과 LSR(Labe Switch Router)을 라우팅 테이블에 유지합니다.
2. MPLS signaling Protocol의 하나인 LDP(Lable Distribution Protocol)는 레이블을 설정하기 위한 정보를 주고 받거나 맵핑 정보를 인접한 라우터 간에 공유 합니다. 
3. MPLS 도메인에 ingress LER에 도착하면 LER은 착신지, QoS 등의 기반을 두고 패킷헤더의 레이블을 붙여, LSP(Label Switch Path)를 통해서 패킷을 포워딩 합니다. 
   * **LSP** : MPLS 네트워크를 통해서 소스에서 목적지까지 패킷이 통과하는 경로로써 모든 네트워크 위치에서 데이터 전송을 위해 LSP를 설정해야 합니다. 
4. 레이블을 부착한 패킷은 ingress LER에 도착할 때 까지 네트워크 계층에서 패킷 헤더를 해석할 필요가 없으며, 레이블을 통해 포워딩 합니다. 즉, LSR에서는 레이블에 따라 L2 계층에서 패킷을 전달합니다. 
5. LSR에서는 각 패킷의 레이블을 읽고 자신이 유지하고 있는 라우팅 테이블의 목록에 따라 레이블을 새로운 레이블로 변환하여 패킷을 다음 노드로 전달합니다. 이와 같은 과정이 LSR간에 반복되며 LSR에서 포워딩된 패킷을 수신한 egress LER은 레이블을 제거하고 패킷의 헤더를 읽고 최종 목적지에 패킷을 전달합니다.

#### MPLS 계층 

* MPLS는 L2 계층에 속해 있는지 L3 계층에 속해있는지를 두고 논란이 있습니다. MPLS는 OSI 계층에 딱 들어맞지 않기 때문에 기존의 네트워크 개념과는 다르다고 할 수 있습니다.
* MPLS의 핵심적인 장점은 중에 하나는 포워딩 기반 네트워킹과 데이터 링크 서비스가 분리되어 있다는 점입니다. 따라서 어느 기반 프로토콜에서든 포워딩 테이블을 만들 수 있습니다. 

##### MPLS 하위요소 

* **Label**
  * 레이블은 MPLS 라우터에서 패킷을 포워딩해야 할 위치를 결정하기 위한 모든 요소가 포함되어 있습니다. 
* **Experimental**
  * 익스페리멘탈 비트에서 QoS에서 레이블이 있는 패킷에 적용할 우선 순위를 설정하는 데 사용됩니다. 
*  **Bottom-of-Stack**
  * MPLS 라우터에 여기가 마지막 장소인지, 더 이상 관련된 레이블이 없는지 여부를 알려줍니다. (마지막 출구 라우터)
* **Time-To-Live**
  * 패킷의 홉 횟수를 식별합니다. 

#### MPLS의 장단점 

* MPLS 자체는 암호화를 제공하지는 않지만 VPN 처럼 공용 인터넷에서 따로 떨어져 작동하기 때문에 안전한 전송 모드로 간주됩니다. 또한 순수 IP 기반 네트워크에 타격을 입힐 수 있는 DDOS에 취약하지 않습니다. 

* 효율적으로 대역폭을 사용할 수 있으며, 네트워크 혼잡을 감소할 수 있기 때문에 사용자의 경험이 향상됩니다. 

  * 구축만 되면 실시간 트래픽을 위한 성능을 완벽하게 보장합니다. 

* 단, MPLS는 통신사로부터 구매해야 하는 서비스 입니다. 따라서 기업은 MPLS 서비스 프로바이더를 찾아야 하며, 프로바이더는 다른 서비스 프로바이더와 파트너십을 통해서 서비스 범위를 확장해 나가야 하기 때문에 일반적인 네트워크 구축보다 더  많은 비용이 들어간다는 단점을 가지고 있습니다. 

* MPLS는 사전경로(LSP)를 미리 셋팅해야 하며, 한번 고정된 경로가 올라가면 이후 변경하기가 어렵습니다. 

   

#### SD-WAN

![](https://fnjhs695glzfgbnk-zippykid.netdna-ssl.com/wp-content/uploads/2018/01/sd-wan-portal-flow-en.png)

* SDN (Software Defined Network)에 기반하여 WAN 영역까지 확장한 개념으로 MPLS에 강력한 대항마로 부상하고 있습니다. 
* SD-WAN은 미래의 기술이 아닌 이미 상용화되었으며, 기술적으로 어느정도 성숙한 정도에 이르렀다고 평가하고 있습니다. 
* MPLS에 비해서 SD-WAN이 부상하고 있는 이유는 기존의 브로드밴드 회선을 사용하여 대역폭을 대폭 향상시킬 수 있으며, 여러망을 Underlay(overlay network가 구축되는 물리적 네트워크)로 두어서 가용성이 개선되고, 프로비저닝, 설정변경을 중앙의 서버에서 일괄적이며 자동으로 수행할 수 있기 때문에 빠르고 OPEX(운영비용)이 상당히 절감될 수 있기 때문입니다.
* 미국의 경우 기존의 ISP가 제공하는 WAN 서비스(MPLS, TDM)에서 SD-WAN으로 마이그레이션 하기 시작했으며, 관련 서비스는 2016년 부터 본격적으로 출시되고 있습니다.



#### SDN-WAN 장점

* MPLS는 기존의 IP 기반의 네트워크에서 많은 변화를 이루었습니다. 하지만 가격이 비싸서 쉽게 도입하지 못한다는 단점을 가지고 있었습니다. 

* SD-WAN은 서비스 프로바이더에 따라 상의하지만 MPLS, LTE, wireless network와 같은 링크를 통해 WAN 동적 라우팅 프로토콜을 지원합니다. 

* 또한, 우선순위나 민감도에 따라서 SD-WAN과 MPLS를 겸용으로 사용함으로서 고가의 MPLS 전용회선에 대한 의존도를 낮추고, 지사, 본사 및 클라우드 간의 전반적인 연결을 향상시킬 수 있도록 합니다. 

  ![](https://www.netmanias.com/ko/?m=attach&no=24892)

* SD-WAN에서는 각 SD-WAN CPE간의 트래픽을 모두 AES로 암호화 하여 IPsec 터널로 전송합니다. 

* 기업에서 인터넷을 통해 기업 트래픽을 전송한다면 가장 중요시 생각하는 것이 보안과 품질입니다. 

  * MPLS은 가격이 비싸지만 고품질과 안전성을 제공합니다. 
  * 하지만 우리가 일반적으로 사용하는 초고속 인터넷은 Latency나 Packet loss가 보장되지않기 때문에 기업에서 critical한 응용 프로그램의 트래픽을 전송해도 되는지에 대한 의구심이 들기 시작합니다. 
  * 이럼에도 불구하고 SD-WAN의 도입이 진행되고 있는 경우는 각 벤더들이 경로제어 및 품질 제어를 가능하게 해주기 때문입니다. 

* MPLS든 인터넷이든 공통점은 패킷망이라는 것인데, 이 때문에 Congestion이 발생할 확률이 존재합니다. 따라서 이러한 트래픽이 특정된 망을 고집하지 않고 망 상황에 따라서 실시간으로 반응하여 경로를 변경해 주는 것이 SD-WAN의 핵심 기술로, 이를 **DPC(Dynamic Path Control)**로 지칭합니다. 

  * 각 SD-WAN CPE는 복수 터널의 품질(Latency, Packet Loss, Jitter, Throughput)을 실시간으로 확인합니다. 

    ![](https://www.netmanias.com/ko/?m=attach&no=24893)


* 데이터 복제, 전송, 마이그레이션과 같은 작업에서 네트워크의 대역폭은 높을수록 좋습니다. 이를 위해서 단일 경로가 아닌 복수의 경로를 동시에 사용하여 데이터를 전달하여 업로드/다운로드의 시간을 줄여주는 것이 중요합니다. 

* 이렇게 복수의 경로에 패킷이 전송되어 사용가능한 대역폭을 최대한 사용할 수 있도록 하는 기술이 **Tunnel Bonding** 이라고 지칭합니다. 

* 단, 여러 경로로 패킷을 분산시켜 전송하면 각 경로로 전송된 패킷이 목적지에 도착했을 때 순서가 변경되어 TCP Retransmission을 유발시켜서 Throughput이 저하되기 때문에 SD-WAN CPE에서 Re-sequencing하여 문제를 해결합니다. 

* 이를 **POC(Packet Order Correction)** 라고 지칭합니다. 

  ![](https://www.netmanias.com/ko/?m=attach&no=24894)



* 우리가 일반적으로 사용하는 인터넷망의 경우 Best Effort Service로 동작하기 때문에 이를 막기 위해서 **FEC(Forward Error Control)**를 패킷에 삽입합니다. 

  ![](https://www.netmanias.com/ko/?m=attach&no=24877)

#### SD-WAN 구조

* SD-WAN은 다음 두가지로 구성되어 있습니다. 
* **중앙 컨트롤러**
  * SD-WAN의 컨트롤 타워의 역할을 담당합니다. 
  * 엑세스 노드 프로비저닝 (엑세스 노드에 대한 정책 설정)
  * 엑세스 노드의 구성 저장 
  * 네트워크 토폴로지 관리 
  * QoS 및 액세스에 대한 정책 설정 및 배포 
  * 사용량 및 성능 보고
* **엑세스 노드**
  * 기업 본사 혹은 지사에 위치하는 SD-WAN용 CPE
  * 별도의 CPE 장비 또는 범용 서버에 가상화된 VNF(Virtual Network Function)으로 구현 
  * 가상 오버레이 네트워크를 생성해내기 위한 라우팅 및 터널링 엔진
  * 하이브리드 WAN 
  * 응용 레벨 모니터링을 포함한 QoS 및 액세스 정책 적용 
  * 네트워크 지연 및 패킷 손실 측정 및 보고 
  * WAN 최적화 
    * 캐싱, 압축, 에러정정, 트래픽 우선순위, 로드 밸런싱

#### SD-WAN의 단점 

* 이러한 장점이 있는 SD-WAN도 몇가지 단점이 존재합니다. 
* 먼저 SD-WAN이 간략화된 네트워킹 모델을 제공하기 위해 설계되었지만, 자체적인 기능만으로는 다른 기능들과 쉽게 통합하지 못하며, 라우팅, 방화벽, 트래픽 관리, 보안 등 기능적 요소들은 SD-WAN core에 맞춤 적용되지만 엔터프라이즈 고객 요구사항의 모든 사항을 지원하지 않습니다. 
* 또한 기업 VPN으로서의 특별한 사용 목적으로 최적화 되었기 때문에 일반적인 서비스로의 확장이 어렵다는 점, 하나의 어플라이언스를 위해 주문형으로 기능을 판매할 수 없다는 것입니다. 
* MPLS의 Peer 구성을 지원하지 않기 때문에 underlay 네트워크에서의 성능정보 확인에 한계가 있고, 실질적으로 SD-WAN을 운영하는데 발생하는 모든 비용과 책임은 기업에게 돌아갑니다. 



#### 진화된 SD-WAN 2.0

![](https://netmanias.com/ko/?m=attach&no=18609)



* 이러한 SD-WAN의 단점을 보안하기 위해서 SD-WAN 2.0은 다양한 개선사항을 포함하였습니다. 

* 위의 그림에서 볼 수 있듯이 언급했던 내용을 상당 부분 개선 되었습니다. 

  ![](https://netmanias.com/ko/?m=attach&no=18610)



#### MPLS과 SD-WAN 무엇을 사용해야 할까요? 

* MPLS과 SD-WAN 모두 기존의 네트워크 문제점을 해결하고 좋은 기술임에는 틀림없습니다. 
* 하지만 두 기술 장단점이 명확하기 때문에 목적에 맞지 않는 도입은 높은 비용과 관리의 부담으로 다가올 수 밖에 없습니다. 
* 엔터프라이즈 환경에서 mission critical한 응용 프로그램을 안정적이고 빠르게 사용해야 한다면 MPLS를 사용하는 것이 적절합니다. 
* 하지만, 실시간성 응용 프로그램 사용이 적고, 퍼블릭 클라우드에 이미 서비스를 진행하고 있다면 SD-WAN을 사용하는 것이 안정적인 서비스를 유지할 수 있을 것입니다. 
* 두 기술 모두 충분히 검증되었으며, 상용화 되어 있기 때문에 MPLS와 SD-WAN의 특징을 명확히 숙지하여 사용하는 것이 바람직 할 것입니다. 